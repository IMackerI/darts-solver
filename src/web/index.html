<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darts Solver</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
</head>

<body>
    <!-- Sidebar Navigation -->
    <nav id="sidebar">
        <div class="sidebar-header">
            <span class="logo-icon">üéØ</span>
            <h1>Darts Solver</h1>
        </div>
        <ul class="nav-links">
            <li><a href="#/" class="nav-link active" data-page="landing"><span class="nav-icon">‚åÇ</span>Home</a></li>
            <li><a href="#/calibrate" class="nav-link" data-page="calibration"><span
                        class="nav-icon">‚äï</span>Calibration</a></li>
            <li><a href="#/solve" class="nav-link" data-page="solver"><span class="nav-icon">‚óâ</span>Solver</a></li>
            <li><a href="docs/index.html" class="nav-link" target="_blank" rel="noopener"><span class="nav-icon">üìñ</span>Docs</a></li>
        </ul>
        <div class="sidebar-footer">
            <div id="wasm-status" class="status loading">Loading WASM‚Ä¶</div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main id="content">

        <!-- Landing Page -->
        <section id="page-landing" class="page active">
            <div class="page-inner">
                <div class="hero">
                    <div class="hero-badge">WebAssembly Powered</div>
                    <h2>Darts Solver</h2>
                    <p class="lead">
                        Find the optimal aiming strategy for any game state using probabilistic modelling
                        and Monte Carlo simulation ‚Äî all running in your browser.
                    </p>
                </div>

                <div class="card-grid">
                    <div class="card card--step">
                        <div class="card-step-num">01</div>
                        <h3>Calibrate</h3>
                        <p>
                            Throw darts at the bull's-eye and click where they land.
                            The solver estimates your personal accuracy distribution.
                        </p>
                        <a href="#/calibrate" class="btn btn-card">Start Calibration ‚Üí</a>
                    </div>
                    <div class="card card--step">
                        <div class="card-step-num">02</div>
                        <h3>Solve</h3>
                        <p>
                            Pick a game state and see the optimal aim point, expected throws
                            to finish, and a heatmap of scores across the board.
                        </p>
                        <a href="#/solve" class="btn btn-card">Open Solver ‚Üí</a>
                    </div>
                </div>

                <div class="info-section">
                    <h3>How it works</h3>
                    <ul>
                        <li><strong>Your accuracy</strong> is modelled as a 2D Gaussian distribution estimated from your
                            calibration shots.</li>
                        <li><strong>Dynamic programming</strong> finds the aim point that minimises expected throws for
                            any state.</li>
                        <li><strong>Heatmaps</strong> visualise expected throws or expected points across every possible
                            aim point.</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Calibration Page -->
        <section id="page-calibration" class="page">
            <div class="page-inner page-inner--wide">
                <h2>Calibration</h2>
                <p class="subtitle">Aim at the bull's-eye and click where your darts actually land.</p>

                <div class="two-col">
                    <!-- Canvas column -->
                    <div class="canvas-wrap">
                        <canvas id="calibration-canvas" width="700" height="700"></canvas>
                    </div>

                    <!-- Controls column -->
                    <div class="controls-panel">
                        <div class="control-group">
                            <h3><span class="cg-icon">‚óé</span>Shots</h3>
                            <p id="shot-count">0 shots recorded</p>
                            <div class="btn-row">
                                <button id="btn-undo" class="btn btn-secondary" disabled>Undo Last</button>
                                <button id="btn-clear" class="btn btn-danger" disabled>Clear All</button>
                            </div>
                        </div>

                        <div class="control-group">
                            <h3><span class="cg-icon">‚¨°</span>Distribution</h3>
                            <div id="distribution-info" class="info-box">
                                <p class="muted">Record at least 3 shots to estimate your distribution.</p>
                            </div>
                            <button id="btn-estimate" class="btn" disabled>Estimate Distribution</button>
                        </div>

                        <div class="control-group">
                            <h3><span class="cg-icon">‚¨á</span>Data</h3>
                            <div class="btn-row">
                                <button id="btn-export" class="btn btn-secondary" disabled>Export</button>
                                <button id="btn-import" class="btn btn-secondary">Import</button>
                            </div>
                            <input type="file" id="import-file" accept=".json" hidden>
                        </div>
                    </div>
                </div>

                <div class="instructions-box">
                    <h3>How to Calibrate</h3>
                    <div class="instructions-content">
                        <h4>What is calibration?</h4>
                        <p>
                            Calibration measures your throwing accuracy.
                            We assume you are aiming at the bull's-eye. Based on where the darts actually land,
                            the solver estimates a distribution. Currently the solver models your throws as
                            a <strong>2D Gaussian (normal) distribution</strong> by estimating your offset (mean) and
                            the spread (covariance matrix) of that distribution.
                        </p>

                        <h4>Step-by-step</h4>
                        <ol>
                            <li><strong>Aim at the bull's-eye.</strong> Every throw should be aimed at the exact center
                                of the board.</li>
                            <li><strong>Click where your dart lands.</strong> Click the corresponding spot on the
                                dartboard canvas. A yellow dot appears for each recorded shot.</li>
                            <li><strong>Repeat 10‚Äì30+ times.</strong> More shots give a better estimate. At least 3 are
                                required, but 15+ is recommended for accuracy.</li>
                            <li><strong>Click "Estimate Distribution"</strong> to compute your covariance matrix. The
                                result shows œÉ<sub>x</sub> and œÉ<sub>y</sub> (standard deviations in mm) and the full
                                covariance.</li>
                            <li><strong>And that's it!</strong> The solver has internally stored your calibration data
                                and is ready to use it in the solver.</li>
                        </ol>

                        <h4>Tips for better results</h4>
                        <ul>
                            <li>Throw naturally ‚Äî don't try to be extra careful. The solver needs your <em>real</em>
                                accuracy.</li>
                            <li>If you missclick, use <strong>Undo Last</strong> to remove the most recent shot.</li>
                            <li>You can <strong>Export</strong> your calibration data as JSON and
                                <strong>Import</strong> it later, so you don't need to re-calibrate each session.</li>
                            <li>The distribution is automatically saved in your browser's local storage.</li>
                        </ul>

                        <h4>What the numbers mean</h4>
                        <p><strong>œÉ<sub>x</sub></strong> and <strong>œÉ<sub>y</sub></strong> are standard deviations in
                            millimetres. The <strong>covariance matrix</strong> [a, b, c, d] captures both the spread
                            and any correlation between horizontal and vertical errors.</p>
                    </div>
                </div>
            </div>
        </section>
        <section id="page-solver" class="page">
            <div class="page-inner page-inner--wide">
                <h2>Solver</h2>
                <p class="subtitle" id="solver-subtitle">Configure and solve for optimal dart strategy.</p>

                <div class="two-col">
                    <!-- Canvas column -->
                    <div class="canvas-wrap">
                        <div class="canvas-toolbar">
                            <label class="toggle-label toggle-label--inline">
                                <input type="checkbox" id="show-heatmap">
                                <span>Heatmap</span>
                            </label>
                        </div>
                        <canvas id="solver-canvas" width="700" height="700"></canvas>
                    </div>

                    <!-- Controls column -->
                    <div class="controls-panel">
                        <div class="control-group">
                            <h3><span class="cg-icon">‚öô</span>Game Settings</h3>
                            <label class="field">
                                <span>Game Mode</span>
                                <select id="game-mode">
                                    <option value="finishOnDouble">Finish on Double</option>
                                    <option value="finishOnAny">Finish on Any</option>
                                </select>
                            </label>
                            <label class="field">
                                <span>State (points remaining)</span>
                                <div class="state-nav">
                                    <button id="btn-state-prev" class="btn btn-secondary btn-arrow"
                                        title="Previous state (‚Üê)">‚óÄ</button>
                                    <input type="number" id="game-state" min="1" max="501" value="501">
                                    <button id="btn-state-next" class="btn btn-secondary btn-arrow"
                                        title="Next state (‚Üí)">‚ñ∂</button>
                                </div>
                            </label>
                        </div>

                        <div class="control-group">
                            <h3><span class="cg-icon">‚óà</span>Solver</h3>
                            <label class="field">
                                <span>Solver Type</span>
                                <select id="solver-type">
                                    <option value="minThrows">Minimize Throws (DP)</option>
                                    <option value="maxPoints">Maximize Points (Greedy)</option>
                                </select>
                            </label>
                            <label class="field">
                                <span>Aim Samples</span>
                                <input type="number" id="aim-samples" min="100" max="50000" value="5000">
                            </label>
                            <button id="btn-solve" class="btn">Solve</button>
                        </div>

                        <div class="control-group">
                            <h3><span class="cg-icon">‚òÖ</span>Results</h3>
                            <div id="solve-results" class="info-box">
                                <p class="muted">Press Solve to compute the optimal strategy.</p>
                            </div>
                        </div>

                        <div class="control-group">
                            <h3><span class="cg-icon">‚äû</span>Visualization</h3>
                            <label class="field" id="heatmap-res-field" style="display:none">
                                <span>Heatmap Resolution</span>
                                <select id="heatmap-resolution">
                                    <option value="30">30 √ó 30 (fast)</option>
                                    <option value="50" selected>50 √ó 50</option>
                                    <option value="100">100 √ó 100 (slow)</option>
                                </select>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="instructions-box">
                    <h3>How to Use the Solver</h3>
                    <div class="instructions-content">
                        <h4>Game Settings</h4>
                        <ul>
                            <li><strong>Game Mode:</strong> "Finish on Double" is standard darts (x01) ‚Äî you must hit a
                                double to check out. "Finish on Any" allows finishing on any scoring segment.</li>
                            <li><strong>State:</strong> The number of points remaining. For example, in a 501 game you
                                start at state 501. Use the ‚óÄ ‚ñ∂ buttons or <kbd>‚Üê</kbd> <kbd>‚Üí</kbd> arrow keys to step
                                through states.</li>
                        </ul>

                        <h4>Solver Types</h4>
                        <ul>
                            <li>
                                <strong>Minimize Throws (DP):</strong> Uses dynamic programming to find the aim point
                                that minimizes the <em>expected number of throws</em> to reach 0. Best for states ‚â§ 1000
                                (higher values are too slow). This is the strategic solver for real games.
                                <ul><li>Use this setting to find out the best aiming spots for a precise game scenario.</li></ul>
                            </li>
                            <li>
                                <strong>Maximize Points (Greedy):</strong> A simpler greedy solver that maximizes the
                                expected points per throw, ignoring future states. Works for any state value. Useful for
                                understanding raw scoring potential.
                                <ul><li>You can use this with high points remaining to see what is the best scoring spot for you in general.</li></ul>
                            </li>
                        </ul>

                        <h4>Reading the Results</h4>
                        <ul>
                            <li>The <strong>red crosshair</strong> on the board shows the computed optimal aim point.
                            </li>
                            <li><strong>Expected throws/points</strong> tells you the average outcome given your
                                accuracy distribution.</li>
                            <li><strong>Aim Samples</strong> controls how many candidate aim points are tested. Higher =
                                more accurate but slower. 5000 is a good default.</li>
                        </ul>

                        <h4>Heatmap</h4>
                        <p>Toggle the heatmap to see how the expected outcome varies across <em>every</em> possible aim
                            point:</p>
                        <ul>
                            <li><strong>Minimize Throws:</strong> Uses a turbo colour scale (blue = best, red = worst).
                                Values are shown as "throws above the optimum" on a logarithmic scale, capped at +50.
                            </li>
                            <li><strong>Maximize Points:</strong> Uses a linear red-to-green scale (green = highest
                                expected points).</li>
                            <li>Increase the <strong>resolution</strong> (50√ó50 ‚Üí 100√ó100) for a smoother picture, at
                                the cost of computation time.</li>
                        </ul>
                        <p>This way you can find out if your previous aim point was close to optimal or not really :)</p>

                        <h4>Keyboard shortcuts</h4>
                        <table class="shortcut-table">
                            <tr>
                                <td><kbd>‚Üê</kbd></td>
                                <td>Previous state (‚àí1) and auto-solve</td>
                            </tr>
                            <tr>
                                <td><kbd>‚Üí</kbd></td>
                                <td>Next state (+1) and auto-solve</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="overlay hidden">
        <div class="spinner"></div>
        <p id="loading-message">Computing...</p>
    </div>

    <!-- Heatmap tooltip -->
    <div id="heatmap-tooltip" class="heatmap-tooltip hidden"></div>

    <script src="darts_wasm.js"></script>
    <script type="module" src="js/main.js"></script>
</body>

</html>